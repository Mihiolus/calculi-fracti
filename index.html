<html>

<head>
    <meta charset="utf-8">
    <title>Calculi Fracti</title>
    <link rel="icon" href="icon.png">
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <h1>Calculi Fracti: A Roman fractional calculator</h1>
    <a href="https://github.com/Mihiolus/calculi-fracti">Site created and hosted on GitHub</a>
    <p>You can find out how Romans worked fractions in <a
            href="https://en.wikipedia.org/wiki/Roman_numerals#Fractions">this Wikipedia article</a>.</p>

    <table id="calc" style="width:250px;">
        <tr>
            <td colspan="4" id="expression_roman" class="number_field"></td>
        </tr>
        <tr>
            <td colspan="4" id="expression_word" class="number_field"></td>
        </tr>
        <tr class="arabic_display">
            <td colspan="4" id="expression_arabic" class="number_field"></td>
        </tr>
        <tr>
            <td colspan="4" id="output_roman" class="number_field"></td>
        </tr>
        <tr>
            <td colspan="4" id="output_word" class="number_field"></td>
        </tr>
        <tr class="arabic_display">
            <td colspan="4" id="output_arabic" class="number_field"></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td><input type="button" value="c" onclick="clr()"></td>
            <td><input type="button" value="←" onclick="backspace()"></td>
        </tr>
        <tr>
            <td><input type="button" value=7 onclick="store('7')"></td>
            <td><input type="button" value=8 onclick="store('8')"></td>
            <td><input type="button" value=9 onclick="store('9')"></td>
            <td><input type="button" value=÷ onclick="add_operand('÷')"></td>
        </tr>
        <tr>
            <td><input type="button" value=4 onclick="store('4')"></td>
            <td><input type="button" value=5 onclick="store('5')"></td>
            <td><input type="button" value=6 onclick="store('6')"></td>
            <td><input type="button" value=× onclick="add_operand('×')"></td>
        </tr>
        <tr>
            <td><input type="button" value=1 onclick="store('1')"></td>
            <td><input type="button" value=2 onclick="store('2')"></td>
            <td><input type="button" value=3 onclick="store('3')"></td>
            <td><input type="button" value=− onclick="add_operand('−')"></td>
        </tr>
        <tr>
            <td><input type="button" value=0 onclick="store('0')"></td>
            <td><input type="button" value=. onclick="store('.')"></td>
            <td><input type="button" value="=" onclick="solve()"></td>
            <td><input type="button" value="+" onclick="add_operand('+')"></td>
        </tr>
    </table>

    <fieldset style="width: 250px;">
        <legend>Style for large numbers:</legend>

        <div>
            <input type="radio" id="apostr" name="large_style" onclick="change_style('apostr')">
            <label for="apostr">CIↃ IↃↃ CCIↃↃ</label>
        </div>

        <div>
            <input type="radio" id="apostr_tight" name="large_style" onclick="change_style('apostr_tight')">
            <label for="apostr_tight">ↀ ↁ ↂ</label>
        </div>

        <div>
            <input type="radio" id="vincul" name="large_style" onclick="change_style('vincul')">
            <label for="vincul" style="position:relative; top: 2px;"><span style="border-top:1px solid;">I</span> <span
                    style="border-top:1px solid;">V</span> <span style="border-top:1px solid;">X</span></label>
        </div>

        <div>
            <input type="radio" id="vincul_with_m" name="large_style" onclick="change_style('vincul_with_m')" checked>
            <label for="vincul_with_m" style="position:relative; top: 2px;">M <span
                    style="border-top:1px solid;">V</span> <span style="border-top:1px solid;">X</span></label>
        </div>
    </fieldset>

    <input type="checkbox" id="show_arabic" onclick="show_arabic()" checked>
    <label for="show_arabic">Show Arabic fields</label>

    <p>N.B.: Only valid Roman numbers are displayed, i.e. greater or equal to 1&frasl;12 or 1 uncia.</p>

    <script>
        arabicOutput = "";
        arabicExpression = [];
        newInput = false;
        hasComma = false;
        arabicVisible = true;

        large_lookups = {
            apostr: {
                CCCIↃↃↃ: 100000,
                IↃↃↃ: 50000,
                CCIↃↃ: 10000,
                IↃↃ: 5000,
                CIↃ: 1000,
                CCIↃ: 900
            },
            apostr_tight: {
                ↈ: 100000,
                ↇ: 50000,
                ↂ: 10000,
                ↁ: 5000,
                ↀ: 1000,
                Cↀ: 900
            },
            vincul: {
                '<span style="border-top:1px solid;">C</span>': 100000,
                '<span style="border-top:1px solid;">L</span>': 50000,
                '<span style="border-top:1px solid;">X</span>': 10000,
                '<span style="border-top:1px solid;">V</span>': 5000,
                '<span style="border-top:1px solid;">I</span>': 1000,
                'C<span style="border-top:1px solid;">I</span>': 900
            },
            vincul_with_m: {
                '<span style="border-top:1px solid;">C</span>': 100000,
                '<span style="border-top:1px solid;">L</span>': 50000,
                '<span style="border-top:1px solid;">X</span>': 10000,
                '<span style="border-top:1px solid;">V</span>': 5000,
                M: 1000,
                CM: 900
            }
        }
        base_lookup = {
            '\u0110': 500,
            'C\u0110': 400,
            C: 100,
            XC: 90,
            L: 50,
            XL: 40,
            X: 10,
            IX: 9,
            V: 5,
            IV: 4,
            I: 1,
            S: 0.5,
            '\u2059': 5 / 12,
            '\u00B7': 1 / 12
        }
        lookup = { ...large_lookups.vincul_with_m, ...base_lookup }

        let calc = document.getElementById("calc");
        document.addEventListener('keydown', processKey);
        Array.from(calc.getElementsByTagName("input")).forEach(
            i => i.addEventListener('keydown', preventEnter)
        );

        function processKey(event) {
            if (event.key >= '0' && event.key <= '9' || event.key == '.') {
                store(event.key);
            } else if (event.key == '+' || event.key == '-' ||
                event.key == '*' || event.key == '/') {
                var converted_operand = inverse_convert_operands(event.key);
                add_operand(converted_operand);
            } else if (event.key == 'Backspace') {
                backspace();
            } else if (event.key == 'Escape') {
                clr();
            } else if (event.key == 'Enter') {
                solve();
            }
        }

        function preventEnter(event) {
            if (event.key == "Enter") {
                event.preventDefault();
            }
        }

        function store(value) {
            if (newInput) {
                clr();
                newInput = false;
            }
            if (value == '.') {
                if (hasComma) {
                    return;
                } else {
                    hasComma = true;
                }
            }
            arabicOutput += value;
            setArabicOutput(arabicOutput);
            setRomanOutput(convert(arabicOutput));
            setWordOutput(toWords(arabicOutput));
        }
        function change_style(value) {
            lookup = { ...large_lookups[value], ...base_lookup }
            updateRomanDisplays();
        }
        function updateRomanDisplays() {
            setRomanOutput(convert(arabicOutput));
            let romanExpression = [];
            for (var i = 0; i < arabicExpression.length; i++) {
                if (isNumber(arabicExpression[i])) {
                    romanExpression.push(convert(arabicExpression[i]));
                } else {
                    romanExpression.push(arabicExpression[i]);
                }
            }
            setRomanExpression(romanExpression.join(''));
        }
        function updateArabicDisplays() {
            setArabicOutput(arabicOutput);
            setArabicExpression(arabicExpression);
        }
        function isNumber(string) {
            return !isNaN(string);
        }
        function convert(arabic) {
            var roman = '',
                i,
                num = arabic;
            for (i in lookup) {
                while (num >= lookup[i]) {
                    roman += i;
                    num -= lookup[i];
                }
            }
            return roman;
        }

        word_lookup = {
            mille: 1000,
            nongenta: 900,
            octingenta: 800,
            septingenta: 700,
            sescenta: 600,
            quingenta: 500,
            quadringenta: 400,
            trecenta: 300,
            ducenta: 200,
            centum: 100,
            nonaginta: 90,
            octoginta: 80,
            septuaginta: 70,
            sexaginta: 60,
            quinquaginta: 50,
            quadraginta: 40,
            triginta: 30,
            viginti: 20,
            undeviginti: 19,
            duodeviginti: 18,
            septendecim: 17,
            sedecim: 16,
            quindecim: 15,
            quattuordecim: 14,
            tredecim: 13,
            duodecim: 12,
            undecim: 11,
            decem: 10,
            novem: 9,
            octo: 8,
            septem: 7,
            sex: 6,
            quinque: 5,
            quattuor: 4,
            tria: 3,
            duo: 2,
            unum: 1
        }

        prefixes = {
            unde: -1,
            duode: -2
        }

        word_lookup_fractions = {
            deunx: 11 / 12,
            semis: 0.5,
            uncia: 1 / 12
        }

        function toWords(arabic) {
            var words = [], i;
            if (arabic >= 2000) {
                let thousands = Math.floor(arabic / 1000);
                words.push(toWords(thousands));
                words.push("millia");
                arabic -= thousands * 1000;
            }
            for (i in word_lookup) {
                if (arabic >= word_lookup[i]) {
                    words.push(i);
                    arabic -= word_lookup[i];
                } else if (arabic >= 18 && arabic < 98) {
                    for (j in prefixes) {
                        if (arabic >= word_lookup[i] + prefixes[j]) {
                            words.push(j + i);
                            arabic -= word_lookup[i] + prefixes[j];
                        }
                    }
                }
            }
            var fractional = [];
            for (i in word_lookup_fractions) {
                if (arabic >= word_lookup_fractions[i]) {
                    fractional.push(i);
                    arabic -= word_lookup[i];
                }
            }

            if (fractional.length > 0) {
                if (words.length > 0) {
                    words.push(" et ");
                }
                words.push(fractional.join(" et "));
            }
            return words.join(" ");
        }

        function setWordOutput(value) {
            document.getElementById("output_word").innerHTML = value;
        }

        function clr() {
            setRomanOutput("");
            setRomanExpression("");
            arabicOutput = "";
            setArabicOutput("");
            setArabicExpression("");
            setWordOutput("");
            hasComma = false;
            arabicExpression = [];
        }
        function backspace() {
            arabicOutput = arabicOutput.slice(0, -1);
            setArabicOutput(arabicOutput);
            setRomanOutput(convert(arabicOutput));
        }
        function setRomanOutput(value) {
            document.getElementById("output_roman").innerHTML = value;
        }
        function setRomanExpression(value) {
            document.getElementById("expression_roman").innerHTML = value;
        }
        function setArabicOutput(value) {
            document.getElementById("output_arabic").innerHTML = arabicOutput;
        }
        function setArabicExpression(value) {
            let expressionElement = document.getElementById("expression_arabic");
            if (typeof value === "object") {
                expressionElement.innerHTML = value.join('');
            } else {
                expressionElement.innerHTML = value;
            }
        }
        function add_operand(value) {
            if (newInput) {
                var oldOutput = document.getElementById("output_arabic").innerHTML;
                clr();
                store(oldOutput);
            }
            arabicExpression.push(arabicOutput);
            arabicExpression.push(value);
            arabicOutput = "";
            updateRomanDisplays();
            updateArabicDisplays();
            hasComma = false;
        }
        function solve() {
            add_operand('=');
            let result = Function(`'use strict'; return (${convert_operands(arabicExpression.join('')).slice(0, -1)})`)();
            result = round(result, 2);
            arabicOutput = result;
            setArabicOutput(result);
            setRomanOutput(convert(arabicOutput));
            newInput = true;
        }
        function round(number, precision) {
            return Math.round((number + Number.EPSILON) * Math.pow(10, precision)) / Math.pow(10, precision);
        }
        function convert_operands(expression) {
            expression = expression.replace("−", "-");
            expression = expression.replace("×", "*");
            expression = expression.replace("÷", "/");
            return expression;
        }
        function inverse_convert_operands(expression) {
            expression = expression.replace("-", "−");
            expression = expression.replace("*", "×");
            expression = expression.replace("/", "÷");
            return expression;
        }
        function show_arabic() {
            arabicVisible = !arabicVisible;
            let arabics = document.getElementsByClassName("arabic_display");
            for (let i = 0; i < arabics.length; i++) {
                arabics[i].style.display = arabicVisible ? "" : "none";
            }
        }
    </script>
</body>

</html>